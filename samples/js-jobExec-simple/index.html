<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
            crossorigin="anonymous" />
        <script
            type="importmap"
            crossorigin="anonymous">
            {
                "imports": {
                    "sas-wrappers": "https://cdn.jsdelivr.net/npm/sas-viya-api-wrappers-js/dist/sas-viya-api-wrappers-js.js"
                },
                "integrity": {
                    "https://cdn.jsdelivr.net/npm/sas-viya-api-wrappers-js/dist/sas-viya-api-wrappers-js.js": "sha256-xuJCLRtqUr4cbw6kuHYoW8X2FX4z2w1Dca0VqOQDHNQ="
                }
            }
        </script>
        <title>Call API</title>
    </head>
    <body>
        <div id="app"></div>
        <iframe
            style="width: 95vw; height: 95vh"
            id="output"
            frameborder="0"></iframe>

        <script type="module">
            import { Job, ComputeSession, getComputeContexts } from 'sas-wrappers'

            const populateDropdown = (dropdown, options) => {
                const topElement = document.createElement('option')
                topElement.text = '-- Select --'
                topElement.disabled = true
                topElement.selected = true
                dropdown.appendChild(topElement)
                options.forEach((option) => {
                    const optionElement = document.createElement('option')
                    optionElement.value = option
                    optionElement.text = option
                    dropdown.appendChild(optionElement)
                })
                dropdown.disabled = false
            }

            const generatePrompts = async (prompts, computeSession) => {
                const promptsDiv = document.createElement('div')
                prompts.forEach(async (prompt) => {
                    const select = document.createElement('select')
                    select.id = prompt.name
                    select.name = prompt.name
                    const options = await computeSession.getValues({
                        libraryName: prompt.name.split('_')[0],
                        tableName: prompt.name.split('_')[1],
                        columnName: prompt.name.split('_')[2],
                    })
                    console.log(options)
                    populateDropdown(select, options)
                    select.onchange = async () => {
                        args[prompt.name] = select.value
                    }
                    promptsDiv.appendChild(select)
                })
                return promptsDiv
            }

            const baseURL = 'https://server.demo.sas.com'

            const job = await Job.init({
                baseURL: baseURL,
                name: 'Test Json',
                path: '/Users/student/My Folder',
            })
            const jobParameters = job.getJobParameters()

            const computeSession = await ComputeSession.init({
                baseURL: baseURL,
                contextName: jobParameters._contextName,
            })

            const prompts = jobParameters.filter((param) => !param.name.startsWith('_'))
            const args = {
                _output_type: 'html',
            }

            const promptsDiv = await generatePrompts(prompts, computeSession)
            document.getElementById('app').appendChild(promptsDiv)

            const button = document.createElement('button')
            button.id = 'execute'
            button.innerText = 'Execute'
            button.onclick = async () => {
                const output = await job.execute({ args: args, resultFileName: '_webout.html' })
                document.getElementById('output').srcdoc = output
            }
            document.getElementById('app').appendChild(button)
        </script>
    </body>
</html>
