<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous" />
        <script
            type="importmap"
            crossorigin="anonymous">
            {
                "imports": {
                    "sas-wrappers": "https://cdn.jsdelivr.net/npm/sas-viya-api-wrappers-js/dist/sas-viya-api-wrappers-js.js"
                },
                "integrity": {
                    "https://cdn.jsdelivr.net/npm/sas-viya-api-wrappers-js/dist/sas-viya-api-wrappers-js.js": "sha256-1SgQqv1rkhXlSNL8rEX5ef8giBL6Xi+vCjTEG2vb/RY="
                }
            }
        </script>
        <title>Call API</title>
    </head>
    <body>
        <div id="app"></div>
        <iframe
            style="width: 95vw; height: 95vh"
            id="output"
            frameborder="0"></iframe>

        <script type="module">
            import { Job, ComputeSession, getComputeContexts } from 'sas-wrappers'

            const populateDropdown = (dropdown, options) => {
                const topElement = document.createElement('option')
                topElement.text = '-- Select --'
                topElement.disabled = true
                topElement.selected = true
                dropdown.appendChild(topElement)
                options.forEach((option) => {
                    const optionElement = document.createElement('option')
                    optionElement.value = option
                    optionElement.text = option
                    dropdown.appendChild(optionElement)
                })
                dropdown.disabled = false
            }
            const baseURL = 'https://server.demo.sas.com'
            const computeSession = await ComputeSession.init({
                baseURL: baseURL,
            })
            const selectColumn = document.createElement('select')
            const columns = await computeSession.getColumns({
                libraryName: 'SASHELP',
                tableName: 'CLASS',
                outputType: 'api',
            })
            if (columns) {
                const options = columns.map((column) => column.name)
                populateDropdown(selectColumn, options)
            }
            selectColumn.onchange = async () => {
                selectValue.replaceChildren()
                selectValue.disabled = true
                const data = await computeSession.getValues({
                    libraryName: 'SASHELP',
                    tableName: 'CLASS',
                    columnName: selectColumn.value,
                })
                if (data) {
                    populateDropdown(selectValue, data)
                }
            }
            const selectValue = document.createElement('select')
            selectValue.onchange = async () => {
                const data = await computeSession.getValues({
                    libraryName: 'SASHELP',
                    tableName: 'CLASS',
                    columnName: selectColumn.value,
                })
                if (data) {
                    console.log(columns)
                    const job = await Job.init({
                        baseURL: 'https://server.demo.sas.com',
                        name: 'Test Json',
                        path: '/Users/student/My Folder',
                    })
                    const args = {
                        _output_type: 'json',
                        value: selectValue.value,
                        column: selectColumn.value,
                        type: columns.find((column) => column.name === selectColumn.value).type,
                    }
                    const output = await job.execute({ args: args, resultFileName: '_webout.json' })
                    document.getElementById('output').srcdoc = output
                }
            }
            const App = document.getElementById('app')
            const div = document.createElement('div')
            div.appendChild(selectColumn)
            div.appendChild(selectValue)
            App?.appendChild(div)
        </script>
    </body>
</html>
